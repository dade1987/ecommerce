# =============================================================================
# Docker Compose - Production
# Per deploy su Plesk con MySQL esterno
# Dominio: demo-avatar.trentaduebit.it
# =============================================================================

services:
  app:
    build:
      context: ..
      dockerfile: docker-prod-mac-local/Dockerfile
    image: avatar-3d-v1-local:latest
    container_name: avatar-3d-v1-prod
    restart: unless-stopped
    ports:
      - "8080:80"  # Porta 8080 per evitare conflitti con Plesk
    environment:
      # App
      - APP_NAME=Avatar3D
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=https://demo-avatar.trentaduebit.it
      - APP_KEY=${APP_KEY}

      # Database (MySQL di Plesk)
      - DB_CONNECTION=mysql
      - DB_HOST=${DB_HOST:-172.17.0.1}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}

      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_ASSISTANT_ID=${OPENAI_ASSISTANT_ID}

      # Cache & Session
      - CACHE_DRIVER=file
      - SESSION_DRIVER=file
      - QUEUE_CONNECTION=database

      # Mail (opzionale)
      - MAIL_MAILER=${MAIL_MAILER:-smtp}
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_ENCRYPTION=${MAIL_ENCRYPTION:-tls}

      # Migrations
      - RUN_MIGRATIONS=${RUN_MIGRATIONS:-false}

      # Playwright
      - PLAYWRIGHT_BROWSERS_PATH=/usr/bin
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

      # Azure TTS (Avatar 3D)
      - AZURE_SPEECH_KEY=${AZURE_SPEECH_KEY}
      - AZURE_SPEECH_REGION=${AZURE_SPEECH_REGION:-italynorth}
      - AZURE_DEFAULT_VOICE=${AZURE_DEFAULT_VOICE:-it-IT-ElsaNeural}
      - AVATAR3D_USE_NODE_PROCESS=true

    volumes:
      # Persistenza storage (uploads, logs, cache)
      - storage_data:/var/www/html/storage/app
      - storage_logs:/var/www/html/storage/logs

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  storage_data:
    driver: local
  storage_logs:
    driver: local